# Migration Guide: 1.1 -> 1.5

## Breaking in 1.5

- Legacy DSL dependency strings were removed.
  - removed: `dependencies = listOf("core", "x >=1 <2")`
  - required: `dependencySpecs = listOf(dependency("core"), dependency("x", ">=1 <2"))`
- Legacy command DSL registration was removed.
  - removed: `commands { command("id", ...) { ... } }`
  - required: `commands { spec(...) { ... } }` or `commands { command(spec = CommandSpec(...)) { ... } }`
- Deprecated validated command helpers were removed.
  - removed: `registerValidated`, `registerOrReplaceValidated`
  - required: `registerSpec(..., middleware = listOf(validationMiddleware { ... }))`
- Deprecated alias shortcut command helpers were removed.
  - removed: `registerWithAliases`, `registerOrReplaceWithAliases`
  - required: `register` / `registerOrReplace` + explicit `registerAliasOrThrow`
- Deprecated dependency string parser was removed.
  - removed: `dependencySpec("id >=1 <2")`
  - required: `dependency("id", ">=1 <2")`
- String-based command registry API was removed.
  - removed: `register(...)`, `registerOrReplace(...)`, `registerResult(...)`
  - required: `registerSpec(...)` / `registerOrReplaceSpec(...)`
- Command sender is now typed.
  - removed: `sender: String`
  - required: `CommandSender` (`sender.id`, `sender.type`)
- Command pre/post events now carry typed responses and rich errors.
  - `GigaCommandPreExecuteEvent.overrideResponse: CommandResult?`
  - `GigaCommandPostExecuteEvent.response: CommandResult`
  - `GigaCommandPostExecuteEvent.error: CommandError?`

## 1) Commands: Move to CommandSpec-first

Preferred:

```kotlin
commands {
    spec(
        command = "example",
        argsSchema = listOf(CommandArgSpec("name", CommandArgType.STRING))
    ) { _, args ->
        CommandResult.ok(args.string("name") ?: "")
    }
}
```

Why:
- deterministic middleware chain
- typed args
- built-in help/completion integration.

## 2) Events: Adopt EventSubscriptionOptions

Use explicit options when behavior matters:

```kotlin
ctx.events.subscribe<GigaTickEvent>(
    EventSubscriptionOptions(priority = EventPriority.HIGH, mainThreadOnly = true)
) { /* ... */ }
```

## 3) Host Mutations: Batch Permission Required

If using `ctx.host.applyMutationBatch(...)`, declare:

```yaml
permissions:
  - host.mutation.batch
```

and keep per-operation host permissions as before.

## 4) Adapter Security Scopes

If runtime policy enables adapter permission scopes, declare:

```yaml
permissions:
  - adapter.invoke.*
  - adapter.capability.*
```

or tighten to specific IDs/capabilities.

## 5) Assets Pipeline

Validate and bundle assets during plugin startup/build:

```kotlin
val validation = ctx.validateAssets()
val bundle = ctx.buildResourcePackBundle()
```

Fix validation failures before release; invalid bundles fail runtime reload and roll back.

## 6) Plugin Network Channels

Register channel contracts explicitly and send schema-versioned messages:

```kotlin
ctx.registerNetworkChannel(PluginChannelSpec(id = "demo:chat", schemaVersion = 1))
ctx.sendPluginMessage("demo:chat", mapOf("text" to "hello"))
```

Handle `PluginMessageStatus` for quota/backpressure/schema failures.

## 7) Observability and Recommendations

Before release, check:

- `doctor --json` and inspect plugin hotspots/fault budgets.
- `profile <plugin> --json` and inspect:
  - `slowSystems`
  - `adapterHotspots`
  - `isolatedSystems`
  - `faultBudget`.


