name: release-assets

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v1.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  upload-jars:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Resolve release tag
        id: tag
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          if [ -z "$TAG" ]; then
            echo "Tag is empty" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build standalone release candidate artifacts
        run: ./gradlew --no-daemon clean standaloneReleaseCandidateArtifacts

      - name: Prepare release assets
        id: assets
        shell: bash
        run: |
          mkdir -p release-assets
          VERSION="${{ steps.tag.outputs.version }}"
          mapfile -t JARS < <(find build/release-standalone -type f -name "*.jar" | sort)
          if [ "${#JARS[@]}" -ne 3 ]; then
            echo "Expected exactly 3 jar artifacts (standalone, cli, demo), found ${#JARS[@]}" >&2
            exit 1
          fi
          for src in "${JARS[@]}"; do
            base="$(basename "$src")"
            out="$(echo "$base" | sed -E "s/-[0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?\.jar$/-$VERSION.jar/")"
            cp "$src" "release-assets/$out"
          done
          if ! ls release-assets/clockwork-standalone-*.jar >/dev/null 2>&1; then
            echo "Missing standalone jar in release-assets" >&2
            exit 1
          fi
          if ! ls release-assets/clockwork-cli-*.jar >/dev/null 2>&1; then
            echo "Missing cli jar in release-assets" >&2
            exit 1
          fi
          if ! ls release-assets/clockwork-demo-standalone-*.jar >/dev/null 2>&1; then
            echo "Missing demo jar in release-assets" >&2
            exit 1
          fi
          mapfile -t RELEASE_JARS < <(find release-assets -maxdepth 1 -type f -name "*.jar" | sort)
          : > release-assets/ARTIFACTS.txt
          : > release-assets/SHA256SUMS.txt
          printf '{\n  "tag": "%s",\n  "version": "%s",\n  "artifacts": [\n' "${{ steps.tag.outputs.tag }}" "$VERSION" > release-assets/ARTIFACTS.json
          for i in "${!RELEASE_JARS[@]}"; do
            jar="${RELEASE_JARS[$i]}"
            name="$(basename "$jar")"
            size="$(wc -c < "$jar" | tr -d ' ')"
            sha="$(sha256sum "$jar" | awk '{print $1}')"
            printf '%s\n' "$name" >> release-assets/ARTIFACTS.txt
            printf '%s  %s\n' "$sha" "$name" >> release-assets/SHA256SUMS.txt
            sep=","
            if [ "$i" -eq "$((${#RELEASE_JARS[@]} - 1))" ]; then
              sep=""
            fi
            printf '    {"name":"%s","sizeBytes":%s,"sha256":"%s"}%s\n' "$name" "$size" "$sha" "$sep" >> release-assets/ARTIFACTS.json
          done
          printf '  ]\n}\n' >> release-assets/ARTIFACTS.json
          ls -lah release-assets

      - name: Verify release asset manifests and checksums
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t RELEASE_JARS < <(find release-assets -maxdepth 1 -type f -name "*.jar" | sort)
          if [ "${#RELEASE_JARS[@]}" -ne 3 ]; then
            echo "Expected exactly 3 release jars, found ${#RELEASE_JARS[@]}" >&2
            exit 1
          fi
          mapfile -t ARTIFACT_LINES < <(sort release-assets/ARTIFACTS.txt)
          mapfile -t JAR_LINES < <(printf '%s\n' "${RELEASE_JARS[@]}" | xargs -n1 basename | sort)
          if [ "${ARTIFACT_LINES[*]}" != "${JAR_LINES[*]}" ]; then
            echo "ARTIFACTS.txt does not match built jar set" >&2
            exit 1
          fi
          (cd release-assets && sha256sum -c SHA256SUMS.txt)
          python - <<'PY'
          import hashlib
          import json
          from pathlib import Path

          root = Path("release-assets")
          manifest = json.loads((root / "ARTIFACTS.json").read_text(encoding="utf-8"))
          artifacts = manifest.get("artifacts", [])
          if len(artifacts) != 3:
              raise SystemExit(f"Expected 3 artifacts in ARTIFACTS.json, found {len(artifacts)}")
          jar_files = sorted(root.glob("*.jar"))
          jar_names = [p.name for p in jar_files]
          manifest_names = sorted(a["name"] for a in artifacts)
          if manifest_names != sorted(jar_names):
              raise SystemExit("ARTIFACTS.json artifact names do not match release jars")

          for artifact in artifacts:
              path = root / artifact["name"]
              if not path.exists():
                  raise SystemExit(f"Missing jar listed in ARTIFACTS.json: {artifact['name']}")
              actual_size = path.stat().st_size
              if actual_size != int(artifact["sizeBytes"]):
                  raise SystemExit(f"Size mismatch for {path.name}: manifest={artifact['sizeBytes']} actual={actual_size}")
              actual_sha = hashlib.sha256(path.read_bytes()).hexdigest()
              if actual_sha != artifact["sha256"]:
                  raise SystemExit(f"SHA256 mismatch for {path.name}")
          PY

      - name: Upload release assets to GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          gh release upload "${{ steps.tag.outputs.tag }}" release-assets/* --clobber
