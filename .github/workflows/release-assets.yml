name: release-assets

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v1.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  upload-jars:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Resolve release tag
        id: tag
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          if [ -z "$TAG" ]; then
            echo "Tag is empty" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build standalone release candidate artifacts
        run: ./gradlew --no-daemon clean standaloneReleaseCandidateArtifacts

      - name: Prepare release assets
        id: assets
        shell: bash
        run: |
          mkdir -p release-assets
          VERSION="${{ steps.tag.outputs.version }}"
          mapfile -t JARS < <(find build/release-standalone -type f -name "*.jar" | sort)
          if [ "${#JARS[@]}" -ne 3 ]; then
            echo "Expected exactly 3 jar artifacts (standalone, cli, demo), found ${#JARS[@]}" >&2
            exit 1
          fi
          for src in "${JARS[@]}"; do
            base="$(basename "$src")"
            out="$(echo "$base" | sed -E "s/-[0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?\.jar$/-$VERSION.jar/")"
            cp "$src" "release-assets/$out"
          done
          if ! ls release-assets/clockwork-standalone-*.jar >/dev/null 2>&1; then
            echo "Missing standalone jar in release-assets" >&2
            exit 1
          fi
          if ! ls release-assets/clockwork-cli-*.jar >/dev/null 2>&1; then
            echo "Missing cli jar in release-assets" >&2
            exit 1
          fi
          if ! ls release-assets/clockwork-demo-standalone-*.jar >/dev/null 2>&1; then
            echo "Missing demo jar in release-assets" >&2
            exit 1
          fi
          mapfile -t RELEASE_JARS < <(find release-assets -maxdepth 1 -type f -name "*.jar" | sort)
          : > release-assets/ARTIFACTS.txt
          : > release-assets/SHA256SUMS.txt
          printf '{\n  "tag": "%s",\n  "version": "%s",\n  "artifacts": [\n' "${{ steps.tag.outputs.tag }}" "$VERSION" > release-assets/ARTIFACTS.json
          for i in "${!RELEASE_JARS[@]}"; do
            jar="${RELEASE_JARS[$i]}"
            name="$(basename "$jar")"
            size="$(wc -c < "$jar" | tr -d ' ')"
            sha="$(sha256sum "$jar" | awk '{print $1}')"
            printf '%s\n' "$name" >> release-assets/ARTIFACTS.txt
            printf '%s  %s\n' "$sha" "$name" >> release-assets/SHA256SUMS.txt
            sep=","
            if [ "$i" -eq "$((${#RELEASE_JARS[@]} - 1))" ]; then
              sep=""
            fi
            printf '    {"name":"%s","sizeBytes":%s,"sha256":"%s"}%s\n' "$name" "$size" "$sha" "$sep" >> release-assets/ARTIFACTS.json
          done
          printf '  ]\n}\n' >> release-assets/ARTIFACTS.json
          ls -lah release-assets

      - name: Upload release assets to GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          gh release upload "${{ steps.tag.outputs.tag }}" release-assets/* --clobber
